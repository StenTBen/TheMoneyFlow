<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Följ Pengarna</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-500">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globala variabler tillhandahållna av miljön
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

        // Användarmappning
        const userName = "Karl";
        const partnerName = "Emma";
        const partnerId = "partner-emma";
        
        // Element
        const root = document.getElementById('root');

        // Applikations-state
        let db;
        let auth;
        let userId = null;
        let expenses = [];
        let salaries = { mySalary: '', partnerSalary: '' };
        let isDarkMode = true;
        let statusMessage = '';
        let showExplanation = false;
        
        // Initiera Firebase och lyssna på auth
        const initializeFirebase = async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        render();
                        setupExpenseListener();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            statusMessage = "Kunde inte logga in. Kontrollera dina inställningar.";
                            render();
                        }
                    }
                });
            } else {
                statusMessage = "Firebase-konfiguration saknas. Appen kan inte spara data.";
                render();
            }
        };

        const setupExpenseListener = () => {
            if (db && userId) {
                const collectionPath = `/artifacts/${appId}/public/data/expenses`;
                const q = query(collection(db, collectionPath));
                onSnapshot(q, (querySnapshot) => {
                    expenses = [];
                    querySnapshot.forEach((doc) => {
                        expenses.push({ id: doc.id, ...doc.data() });
                    });
                    expenses.sort((a, b) => b.timestamp - a.timestamp);
                    render();
                }, (error) => {
                    statusMessage = "Kunde inte hämta kostnader.";
                    render();
                });
            }
        };
        
        // Funktioner för UI
        const handleInputChange = (e) => {
            const { name, value } = e.target;
            const expense = { ...getNewExpenseData(), [name]: value };
            setNewExpenseData(expense);
        };
        
        const handleSalaryChange = (e) => {
            const { name, value } = e.target;
            salaries = { ...salaries, [name]: value };
            render();
        };

        const handleAddExpense = async (e) => {
            e.preventDefault();
            const newExpense = getNewExpenseData();

            if (!db || !userId) {
                statusMessage = "Appen är inte redo. Vänligen vänta.";
                render();
                return;
            }
            const { description, amount, payerId, splitType } = newExpense;
            if (!description || !amount || !payerId || !splitType) {
                statusMessage = "Alla fält måste fyllas i.";
                render();
                return;
            }
            const parsedAmount = parseFloat(amount);
            if (isNaN(parsedAmount) || parsedAmount <= 0) {
                statusMessage = "Beloppet måste vara ett positivt nummer.";
                render();
                return;
            }
            
            if (splitType === 'salary' && (!salaries.mySalary || !salaries.partnerSalary)) {
                statusMessage = "Du måste ange båda lönerna för att dela baserat på nettolön.";
                render();
                return;
            }

            try {
                const newDocRef = doc(collection(db, `/artifacts/${appId}/public/data/expenses`));
                await setDoc(newDocRef, {
                    description: description,
                    amount: parsedAmount,
                    payerId: payerId,
                    splitType: splitType,
                    timestamp: Date.now(),
                });
                setNewExpenseData({ description: '', amount: '', payerId: '', splitType: 'even' });
                statusMessage = "Kostnad tillagd!";
            } catch (error) {
                statusMessage = "Kunde inte lägga till kostnad.";
            }
            render();
        };

        const calculateBalance = () => {
            if (expenses.length === 0 || !salaries.mySalary || !salaries.partnerSalary) {
                return null;
            }

            const myId = userId;
            const totalSalary = parseFloat(salaries.mySalary) + parseFloat(salaries.partnerSalary);
            if (totalSalary <= 0) return null;

            const mySalaryRatio = parseFloat(salaries.mySalary) / totalSalary;
            const partnerSalaryRatio = parseFloat(salaries.partnerSalary) / totalSalary;

            const payerTotals = {};
            const effectiveBalances = {};
            [myId, partnerId].forEach(id => {
                payerTotals[id] = 0;
                effectiveBalances[id] = 0;
            });
            
            expenses.forEach(exp => {
                payerTotals[exp.payerId] = (payerTotals[exp.payerId] || 0) + exp.amount;
                
                let myPortion = 0;
                let partnerPortion = 0;

                if (exp.splitType === 'even') {
                    myPortion = exp.amount / 2;
                    partnerPortion = exp.amount / 2;
                } else if (exp.splitType === 'salary') {
                    myPortion = exp.amount * mySalaryRatio;
                    partnerPortion = exp.amount * partnerSalaryRatio;
                }
                
                if (exp.payerId === myId) {
                    effectiveBalances[myId] += (exp.amount - myPortion);
                    effectiveBalances[partnerId] -= partnerPortion;
                } else {
                    effectiveBalances[myId] -= myPortion;
                    effectiveBalances[partnerId] += (exp.amount - partnerPortion);
                }
            });

            const summary = {
                balances: effectiveBalances,
                whoOwesWhom: {},
            };

            const payers = Object.entries(effectiveBalances).filter(([, balance]) => balance > 0).sort((a, b) => b[1] - a[1]);
            const receivers = Object.entries(effectiveBalances).filter(([, balance]) => balance < 0).sort((a, b) => a[1] - b[1]);

            let i = 0, j = 0;
            while (i < payers.length && j < receivers.length) {
                const [payerId, payerBalance] = payers[i];
                const [receiverId, receiverBalance] = receivers[j];
                const amountToTransfer = Math.min(payerBalance, Math.abs(receiverBalance));

                summary.whoOwesWhom[receiverId] = summary.whoOwesWhom[receiverId] || {};
                summary.whoOwesWhom[receiverId][payerId] = (summary.whoOwesWhom[receiverId][payerId] || 0) + amountToTransfer;

                payers[i][1] -= amountToTransfer;
                receivers[j][1] += amountToTransfer;

                if (payers[i][1] < 0.01) i++;
                if (receivers[j][1] > -0.01) j++;
            }

            return summary;
        };
        
        const toggleTheme = () => {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark');
            render();
        };

        const getPayerName = (id) => id === userId ? userName : partnerName;

        const getNewExpenseData = () => {
            const descriptionInput = document.querySelector('[name="description"]');
            const amountInput = document.querySelector('[name="amount"]');
            const payerIdSelect = document.querySelector('[name="payerId"]');
            const splitTypeSelect = document.querySelector('[name="splitType"]');
            
            return {
                description: descriptionInput ? descriptionInput.value : '',
                amount: amountInput ? amountInput.value : '',
                payerId: payerIdSelect ? payerIdSelect.value : '',
                splitType: splitTypeSelect ? splitTypeSelect.value : '',
            };
        };
        
        const setNewExpenseData = (data) => {
             const descriptionInput = document.querySelector('[name="description"]');
             const amountInput = document.querySelector('[name="amount"]');
             const payerIdSelect = document.querySelector('[name="payerId"]');
             const splitTypeSelect = document.querySelector('[name="splitType"]');
             
             if (descriptionInput) descriptionInput.value = data.description;
             if (amountInput) amountInput.value = data.amount;
             if (payerIdSelect) payerIdSelect.value = data.payerId;
             if (splitTypeSelect) splitTypeSelect.value = data.splitType;
        };
        
        const toggleExplanation = () => {
            showExplanation = !showExplanation;
            render();
        };

        const render = () => {
            const balanceSummary = calculateBalance();

            root.innerHTML = `
                <div class="container mx-auto max-w-2xl ${isDarkMode ? 'dark' : ''} min-h-screen p-4 sm:p-8 font-sans transition-colors duration-500">
                    <header class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-emerald-500">
                            Följ Pengarna
                        </h1>
                        <button
                            onclick="toggleTheme()"
                            class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 transition-colors duration-300 shadow-md hover:scale-105"
                            aria-label="Växla tema"
                        >
                            ${isDarkMode ? '☀️' : '🌙'}
                        </button>
                    </header>
                    <p class="text-center text-gray-600 dark:text-gray-400 mb-6">
                        Enkel kostnadsdelning för er som delar allt.
                    </p>
                    ${statusMessage ? `
                        <div class="bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-200 p-3 rounded-md mb-6 shadow-sm text-center">
                            ${statusMessage}
                        </div>
                    ` : ''}

                    <div class="p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-3xl shadow-xl mb-6">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-white">Ange nettolöner</h2>
                        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                            <input
                                type="number"
                                name="mySalary"
                                placeholder="${userName}s nettolön"
                                value="${salaries.mySalary}"
                                oninput="handleSalaryChange(event)"
                                class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-300"
                            />
                            <input
                                type="number"
                                name="partnerSalary"
                                placeholder="${partnerName}s nettolön"
                                value="${salaries.partnerSalary}"
                                oninput="handleSalaryChange(event)"
                                class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-300"
                            />
                        </div>
                    </div>

                    <div class="p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-3xl shadow-xl mb-6">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-white">Lägg till ny kostnad</h2>
                        <form onsubmit="handleAddExpense(event)" class="flex flex-col space-y-4">
                            <input
                                type="text"
                                name="description"
                                placeholder="Beskrivning (t.ex. Hyra)"
                                value=""
                                oninput="handleInputChange(event)"
                                class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-300"
                                required
                            />
                            <input
                                type="number"
                                name="amount"
                                placeholder="Belopp (t.ex. 500)"
                                value=""
                                oninput="handleInputChange(event)"
                                class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-300"
                                required
                            />
                            <div class="relative">
                                <select
                                    name="payerId"
                                    onchange="handleInputChange(event)"
                                    class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-300 appearance-none"
                                    required
                                >
                                    <option value="" disabled selected>Vem betalade?</option>
                                    <option value="${userId}">${userName}</option>
                                    <option value="${partnerId}">${partnerName}</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="relative">
                                <select
                                    name="splitType"
                                    onchange="handleInputChange(event)"
                                    class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-300 appearance-none"
                                    required
                                >
                                    <option value="even">Dela 50/50</option>
                                    <option value="salary">Dela baserat på nettolön</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            <button
                                type="submit"
                                class="w-full py-3 px-4 bg-gradient-to-r from-teal-400 to-emerald-500 text-white font-semibold rounded-xl shadow-lg hover:from-teal-500 hover:to-emerald-600 transition-transform transform hover:scale-105"
                            >
                                Lägg till kostnad
                            </button>
                        </form>
                    </div>

                    ${balanceSummary ? `
                        <div class="p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-3xl shadow-xl mb-6">
                            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-white">Sammanställning</h2>
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                                ${Object.entries(balanceSummary.balances).map(([id, balance]) => `
                                    <div class="flex justify-between items-center py-2">
                                        <span class="font-semibold text-lg">${getPayerName(id)}</span>
                                        <span class="font-bold text-xl ${balance < 0 ? 'text-red-500' : 'text-emerald-500'}">
                                            ${balance > 0 ? '+' : ''}${balance.toFixed(2)} kr
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                                <h3 class="text-lg sm:text-xl font-semibold mb-2 text-gray-800 dark:text-white">Vem ska swisha vem?</h3>
                                ${Object.keys(balanceSummary.whoOwesWhom).length === 0 ? `
                                    <p class="text-gray-500">Allt är jämnt!</p>
                                ` : `
                                    <ul class="space-y-2">
                                        ${Object.entries(balanceSummary.whoOwesWhom).map(([receiverId, transfers]) =>

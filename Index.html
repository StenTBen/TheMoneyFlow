import React, { useState, useEffect } from 'react';
import { Plus, Home, Calendar, Settings, Edit3, Check, X } from 'lucide-react';

const CoupleFinanceApp = () => {
  const [currentView, setCurrentView] = useState('dashboard');
  const [selectedMonth, setSelectedMonth] = useState('2025-06');
  const [editingField, setEditingField] = useState(null);
  const [tempValue, setTempValue] = useState('');

  // Simulerad data (i en riktig app skulle detta synkroniseras mellan anv칛ndare)
  const [data, setData] = useState({
    users: {
      user1: { name: 'Du', netSalary: 35000 },
      user2: { name: 'Din Partner', netSalary: 28000 }
    },
    months: {
      '2025-06': {
        bills: [
          { id: 1, name: 'Hyra', amount: 12000, paidBy: 'user1', category: 'housing' },
          { id: 2, name: 'El', amount: 800, paidBy: 'user2', category: 'utilities' },
          { id: 3, name: 'Internet', amount: 599, paidBy: 'user1', category: 'utilities' }
        ],
        savings: [
          { id: 1, name: 'Sparande', amount: 5000, splitType: 'percentage' },
          { id: 2, name: 'Mat', amount: 4000, splitType: 'equal' },
          { id: 3, name: 'Bensin', amount: 2000, splitType: 'percentage' }
        ]
      }
    }
  });

  const getCurrentMonthData = () => data.months[selectedMonth] || { bills: [], savings: [] };

  const getTotalIncome = () => data.users.user1.netSalary + data.users.user2.netSalary;
  
  const getUser1Percentage = () => (data.users.user1.netSalary / getTotalIncome()) * 100;
  const getUser2Percentage = () => (data.users.user2.netSalary / getTotalIncome()) * 100;

  const calculateBillSplit = () => {
    const monthData = getCurrentMonthData();
    const totalBills = monthData.bills.reduce((sum, bill) => sum + bill.amount, 0);
    const user1Share = (totalBills * getUser1Percentage()) / 100;
    const user2Share = (totalBills * getUser2Percentage()) / 100;
    
    const user1Paid = monthData.bills.filter(b => b.paidBy === 'user1').reduce((sum, bill) => sum + bill.amount, 0);
    const user2Paid = monthData.bills.filter(b => b.paidBy === 'user2').reduce((sum, bill) => sum + bill.amount, 0);
    
    const user1Balance = user1Paid - user1Share;
    const user2Balance = user2Paid - user2Share;
    
    return {
      totalBills,
      user1Share: Math.round(user1Share),
      user2Share: Math.round(user2Share),
      user1Paid,
      user2Paid,
      user1Balance: Math.round(user1Balance),
      user2Balance: Math.round(user2Balance)
    };
  };

  const calculateSavingsSplit = () => {
    const monthData = getCurrentMonthData();
    let user1Total = 0;
    let user2Total = 0;
    
    monthData.savings.forEach(saving => {
      if (saving.splitType === 'equal') {
        user1Total += saving.amount / 2;
        user2Total += saving.amount / 2;
      } else {
        user1Total += (saving.amount * getUser1Percentage()) / 100;
        user2Total += (saving.amount * getUser2Percentage()) / 100;
      }
    });
    
    return {
      totalSavings: monthData.savings.reduce((sum, s) => sum + s.amount, 0),
      user1Share: Math.round(user1Total),
      user2Share: Math.round(user2Total)
    };
  };

  const startEditing = (field, currentValue) => {
    setEditingField(field);
    setTempValue(currentValue.toString());
  };

  const saveEdit = () => {
    const value = parseFloat(tempValue) || 0;
    const [type, ...pathParts] = editingField.split('.');
    
    setData(prevData => {
      const newData = { ...prevData };
      
      if (type === 'salary') {
        const user = pathParts[0];
        newData.users[user].netSalary = value;
      } else if (type === 'bill') {
        const [billId, field] = pathParts;
        const monthData = newData.months[selectedMonth];
        const billIndex = monthData.bills.findIndex(b => b.id === parseInt(billId));
        if (field === 'amount') {
          monthData.bills[billIndex].amount = value;
        }
      } else if (type === 'saving') {
        const [savingId] = pathParts;
        const monthData = newData.months[selectedMonth];
        const savingIndex = monthData.savings.findIndex(s => s.id === parseInt(savingId));
        monthData.savings[savingIndex].amount = value;
      }
      
      return newData;
    });
    
    setEditingField(null);
    setTempValue('');
  };

  const cancelEdit = () => {
    setEditingField(null);
    setTempValue('');
  };

  const addBill = () => {
    const monthData = getCurrentMonthData();
    const newBill = {
      id: Date.now(),
      name: 'Ny r칛kning',
      amount: 0,
      paidBy: 'user1',
      category: 'other'
    };
    
    setData(prevData => ({
      ...prevData,
      months: {
        ...prevData.months,
        [selectedMonth]: {
          ...monthData,
          bills: [...monthData.bills, newBill]
        }
      }
    }));
  };

  const addSaving = () => {
    const monthData = getCurrentMonthData();
    const newSaving = {
      id: Date.now(),
      name: 'Ny post',
      amount: 0,
      splitType: 'percentage'
    };
    
    setData(prevData => ({
      ...prevData,
      months: {
        ...prevData.months,
        [selectedMonth]: {
          ...monthData,
          savings: [...monthData.savings, newSaving]
        }
      }
    }));
  };

  const EditableField = ({ field, value, suffix = '' }) => {
    const isEditing = editingField === field;
    
    if (isEditing) {
      return (
        <div className="flex items-center gap-2">
          <input
            type="number"
            value={tempValue}
            onChange={(e) => setTempValue(e.target.value)}
            className="bg-white border border-pink-300 rounded px-2 py-1 text-sm w-20"
            autoFocus
            onKeyPress={(e) => e.key === 'Enter' && saveEdit()}
          />
          <button onClick={saveEdit} className="text-green-600 p-1">
            <Check size={16} />
          </button>
          <button onClick={cancelEdit} className="text-red-600 p-1">
            <X size={16} />
          </button>
        </div>
      );
    }
    
    return (
      <div className="flex items-center gap-2">
        <span className="font-medium">{value.toLocaleString()}{suffix}</span>
        <button
          onClick={() => startEditing(field, value)}
          className="text-gray-400 hover:text-pink-500 transition-colors"
        >
          <Edit3 size={14} />
        </button>
      </div>
    );
  };

  const DashboardView = () => {
    const billSplit = calculateBillSplit();
    const savingsSplit = calculateSavingsSplit();
    const totalIncome = getTotalIncome();

    return (
      <div className="space-y-6">
        {/* Inkomster */}
        <div className="bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl p-6 border border-pink-100">
          <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            游눯 M친nadsinkomster
          </h2>
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-white rounded-lg p-4 border border-pink-100">
              <div className="text-sm text-gray-600 mb-1">{data.users.user1.name}</div>
              <EditableField 
                field="salary.user1" 
                value={data.users.user1.netSalary} 
                suffix=" kr" 
              />
              <div className="text-xs text-pink-600 mt-1">
                {getUser1Percentage().toFixed(1)}% av totalen
              </div>
            </div>
            <div className="bg-white rounded-lg p-4 border border-pink-100">
              <div className="text-sm text-gray-600 mb-1">{data.users.user2.name}</div>
              <EditableField 
                field="salary.user2" 
                value={data.users.user2.netSalary} 
                suffix=" kr" 
              />
              <div className="text-xs text-pink-600 mt-1">
                {getUser2Percentage().toFixed(1)}% av totalen
              </div>
            </div>
          </div>
          <div className="mt-4 pt-4 border-t border-pink-200">
            <div className="text-lg font-bold text-gray-800">
              Total: {totalIncome.toLocaleString()} kr
            </div>
          </div>
        </div>

        {/* R칛kningar */}
        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
          <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            游 R칛kningar ({billSplit.totalBills.toLocaleString()} kr)
          </h2>
          <div className="grid grid-cols-2 gap-4 mb-4">
            <div className="bg-white rounded-lg p-4 border border-blue-100">
              <div className="text-sm text-gray-600">{data.users.user1.name} ska betala</div>
              <div className="text-lg font-bold text-gray-800">{billSplit.user1Share.toLocaleString()} kr</div>
              <div className="text-xs text-gray-500">Betalat: {billSplit.user1Paid.toLocaleString()} kr</div>
              <div className={`text-sm font-medium ${billSplit.user1Balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {billSplit.user1Balance >= 0 ? '+' : ''}{billSplit.user1Balance.toLocaleString()} kr
              </div>
            </div>
            <div className="bg-white rounded-lg p-4 border border-blue-100">
              <div className="text-sm text-gray-600">{data.users.user2.name} ska betala</div>
              <div className="text-lg font-bold text-gray-800">{billSplit.user2Share.toLocaleString()} kr</div>
              <div className="text-xs text-gray-500">Betalat: {billSplit.user2Paid.toLocaleString()} kr</div>
              <div className={`text-sm font-medium ${billSplit.user2Balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {billSplit.user2Balance >= 0 ? '+' : ''}{billSplit.user2Balance.toLocaleString()} kr
              </div>
            </div>
          </div>
          {Math.abs(billSplit.user1Balance) > 0 && (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
              <div className="text-sm font-medium text-yellow-800">
                {billSplit.user1Balance > 0 
                  ? `${data.users.user2.name} 칛r skyldig ${data.users.user1.name} ${Math.abs(billSplit.user1Balance).toLocaleString()} kr`
                  : `${data.users.user1.name} 칛r skyldig ${data.users.user2.name} ${Math.abs(billSplit.user1Balance).toLocaleString()} kr`
                }
              </div>
            </div>
          )}
        </div>

        {/* Sparande & L칬pande */}
        <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border border-green-100">
          <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            游눜 Sparande & L칬pande ({savingsSplit.totalSavings.toLocaleString()} kr)
          </h2>
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-white rounded-lg p-4 border border-green-100">
              <div className="text-sm text-gray-600">{data.users.user1.name}</div>
              <div className="text-lg font-bold text-gray-800">{savingsSplit.user1Share.toLocaleString()} kr</div>
            </div>
            <div className="bg-white rounded-lg p-4 border border-green-100">
              <div className="text-sm text-gray-600">{data.users.user2.name}</div>
              <div className="text-lg font-bold text-gray-800">{savingsSplit.user2Share.toLocaleString()} kr</div>
            </div>
          </div>
        </div>

        {/* Sammanfattning */}
        <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border border-purple-100">
          <h2 className="text-xl font-bold text-gray-800 mb-4">游늵 M친nadssammanfattning</h2>
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-white rounded-lg p-4 border border-purple-100">
              <div className="text-sm text-gray-600">{data.users.user1.name} totalt</div>
              <div className="text-lg font-bold text-gray-800">
                {(billSplit.user1Share + savingsSplit.user1Share).toLocaleString()} kr
              </div>
              <div className="text-xs text-gray-500">
                {(((billSplit.user1Share + savingsSplit.user1Share) / data.users.user1.netSalary) * 100).toFixed(1)}% av l칬n
              </div>
            </div>
            <div className="bg-white rounded-lg p-4 border border-purple-100">
              <div className="text-sm text-gray-600">{data.users.user2.name} totalt</div>
              <div className="text-lg font-bold text-gray-800">
                {(billSplit.user2Share + savingsSplit.user2Share).toLocaleString()} kr
              </div>
              <div className="text-xs text-gray-500">
                {(((billSplit.user2Share + savingsSplit.user2Share) / data.users.user2.netSalary) * 100).toFixed(1)}% av l칬n
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const MonthView = () => {
    const monthData = getCurrentMonthData();

    return (
      <div className="space-y-6">
        {/* M친nadsselektor */}
        <div className="bg-white rounded-xl p-4 border border-gray-200">
          <label className="block text-sm font-medium text-gray-700 mb-2">V칛lj m친nad</label>
          <input
            type="month"
            value={selectedMonth}
            onChange={(e) => setSelectedMonth(e.target.value)}
            className="border border-gray-300 rounded-lg px-3 py-2 w-full"
          />
        </div>

        {/* R칛kningar */}
        <div className="bg-white rounded-xl p-6 border border-gray-200">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-gray-800">R칛kningar</h2>
            <button 
              onClick={addBill}
              className="bg-pink-500 text-white rounded-full p-2 hover:bg-pink-600 transition-colors"
            >
              <Plus size={20} />
            </button>
          </div>
          <div className="space-y-3">
            {monthData.bills.map((bill) => (
              <div key={bill.id} className="bg-gray-50 rounded-lg p-4 flex justify-between items-center">
                <div className="flex-1">
                  <div className="font-medium text-gray-800">{bill.name}</div>
                  <div className="text-sm text-gray-600">
                    Betald av: {bill.paidBy === 'user1' ? data.users.user1.name : data.users.user2.name}
                  </div>
                </div>
                <div className="text-right">
                  <EditableField 
                    field={`bill.${bill.id}.amount`} 
                    value={bill.amount} 
                    suffix=" kr" 
                  />
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Sparande & L칬pande */}
        <div className="bg-white rounded-xl p-6 border border-gray-200">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-gray-800">Sparande & L칬pande</h2>
            <button 
              onClick={addSaving}
              className="bg-green-500 text-white rounded-full p-2 hover:bg-green-600 transition-colors"
            >
              <Plus size={20} />
            </button>
          </div>
          <div className="space-y-3">
            {monthData.savings.map((saving) => (
              <div key={saving.id} className="bg-gray-50 rounded-lg p-4 flex justify-between items-center">
                <div className="flex-1">
                  <div className="font-medium text-gray-800">{saving.name}</div>
                  <div className="text-sm text-gray-600">
                    {saving.splitType === 'equal' ? 'J칛mn f칬rdelning (50/50)' : 'Procentuell f칬rdelning'}
                  </div>
                </div>
                <div className="text-right">
                  <EditableField 
                    field={`saving.${saving.id}.amount`} 
                    value={saving.amount} 
                    suffix=" kr" 
                  />
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="max-w-md mx-auto bg-gray-50 min-h-screen">
      {/* Header */}
      <div className="bg-gradient-to-r from-pink-500 to-purple-600 text-white p-6 rounded-b-3xl shadow-lg">
        <h1 className="text-2xl font-bold text-center">V친r Ekonomi</h1>
        <div className="text-center text-pink-100 text-sm mt-1">
          Gemensamt & Enkelt 游눗
        </div>
      </div>

      {/* Content */}
      <div className="p-4 pb-24">
        {currentView === 'dashboard' ? <DashboardView /> : <MonthView />}
      </div>

      {/* Bottom Navigation */}
      <div className="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-md bg-white border-t border-gray-200 px-4 py-2">
        <div className="flex justify-around">
          <button
            onClick={() => setCurrentView('dashboard')}
            className={`flex flex-col items-center gap-1 p-3 rounded-xl transition-colors ${
              currentView === 'dashboard' 
                ? 'bg-pink-100 text-pink-600' 
                : 'text-gray-400 hover:text-gray-600'
            }`}
          >
            <Home size={24} />
            <span className="text-xs font-medium">칐versikt</span>
          </button>
          <button
            onClick={() => setCurrentView('month')}
            className={`flex flex-col items-center gap-1 p-3 rounded-xl transition-colors ${
              currentView === 'month' 
                ? 'bg-pink-100 text-pink-600' 
                : 'text-gray-400 hover:text-gray-600'
            }`}
          >
            <Calendar size={24} />
            <span className="text-xs font-medium">M친nader</span>
          </button>
        </div>
      </div>

      {/* Sync Indicator */}
      <div className="fixed top-20 right-4 bg-green-500 text-white text-xs px-2 py-1 rounded-full">
        游댃 Synkad
      </div>
    </div>
  );
};

export default CoupleFinanceApp;
